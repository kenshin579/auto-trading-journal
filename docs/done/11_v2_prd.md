# v2 시트 포맷 개선 및 대시보드 PRD

## 1. 배경

v2 핵심 기능(CSV 파싱, 시트 작성, 요약 시트)이 완성된 상태에서, 시트의 가독성과 활용도를 높이기 위한 개선 작업이 필요하다.

### 현재 문제점

| 문제 | 설명 |
|------|------|
| 헤더 고정 없음 | 스크롤 시 헤더가 사라져 어떤 컬럼인지 알 수 없음 |
| 필터 없음 | 특정 종목/날짜/구분을 필터링할 수 없음 |
| 숫자 포맷 미적용 | 금액이 `56460`으로 표시되어 가독성 저하, 수익률도 일반 숫자로 표시 |
| 요약 시트 분산 | 요약_월별, 요약_종목별이 별도 시트로 분리되어 있어 한눈에 파악이 어려움 |
| 대시보드 기능 부재 | 분산 투자 현황, 수익률 추이, 승률 등 핵심 투자 지표가 없음 |

## 2. 요구사항

### 2.1 매매일지 시트 - 헤더 고정 행

모든 매매일지 시트(국내/해외)의 1행(헤더)을 고정(freeze)하여 스크롤 시에도 헤더가 항상 보이도록 한다.

- **적용 대상**: 모든 매매일지 시트 + 대시보드 시트
- **고정 행 수**: 1행 (헤더 행)
- **적용 시점**: 시트 생성 시 + 기존 시트에도 매 실행 시 적용

### 2.2 매매일지 시트 - 필터 추가

모든 매매일지 시트의 헤더 행에 자동 필터(AutoFilter)를 설정한다.

- **적용 범위**: 헤더 행의 전체 컬럼 (국내: A~I, 해외: A~O)
- **적용 시점**: 시트 생성 시 + 기존 시트에도 매 실행 시 적용
- **주요 필터 활용 사례**:
  - 구분별 필터 (매수만 / 매도만)
  - 종목명별 필터
  - 날짜별 필터

### 2.3 매매일지 시트 - 데이터 포맷

시트에 삽입되는 숫자 데이터에 적절한 표시 형식을 적용한다.

#### 국내계좌 시트 (9컬럼)

| 컬럼 | 헤더 | 포맷 | 예시 |
|------|------|------|------|
| A | 일자 | 텍스트 (YYYY-MM-DD) | 2026-02-13 |
| B | 구분 | 텍스트 | 매수 |
| C | 종목명 | 텍스트 | TIGER 조선TOP10 |
| D | 수량 | 정수 `#,##0` | 2 |
| E | 단가 | 원화 `#,##0` | 28,230 |
| F | 금액 | 원화 `#,##0` | 56,460 |
| G | 수수료 | 원화 `#,##0` | 0 |
| H | 손익금액 | 원화 `#,##0` | -1,200 |
| I | 수익률(%) | 퍼센트 `0.00%` | -2.13% |

#### 해외계좌 시트 (15컬럼)

| 컬럼 | 헤더 | 포맷 | 예시 |
|------|------|------|------|
| A | 일자 | 텍스트 (YYYY-MM-DD) | 2026-02-04 |
| B | 구분 | 텍스트 | 매수 |
| C | 통화 | 텍스트 | USD |
| D | 종목코드 | 텍스트 | AAPL |
| E | 종목명 | 텍스트 | Apple Inc |
| F | 수량 | 정수 `#,##0` | 2 |
| G | 단가 | 소수점 `#,##0.00` | 42.60 |
| H | 금액(외화) | 소수점 `#,##0.00` | 85.20 |
| I | 환율 | 소수점 `#,##0.00` | 1,449.00 |
| J | 금액(원화) | 원화 `#,##0` | 123,454 |
| K | 수수료 | 소수점 `#,##0.00` | 0.00 |
| L | 세금 | 소수점 `#,##0.00` | 0.00 |
| M | 손익(외화) | 소수점 `#,##0.00` | 12.50 |
| N | 손익(원화) | 원화 `#,##0` | 18,113 |
| O | 수익률(%) | 퍼센트 `0.00%` | 14.68% |

#### 포맷 적용 방식

- **숫자 값으로 삽입**: 현재 문자열로 삽입하는 값을 숫자(float/int)로 변환하여 삽입
- **수익률**: `14.68` → `0.1468` (소수)로 저장 후 `0.00%` 포맷 적용
- **적용 시점**: 데이터 삽입 후 배치로 numberFormat 적용

### 2.4 대시보드 시트 (요약 시트 통합 개선)

기존 `요약_월별`과 `요약_종목별` 2개 시트를 **`대시보드`** 1개 시트로 통합하고, 투자 성과를 한눈에 파악할 수 있는 지표를 추가한다.

#### 시트 구성

```
[대시보드 시트]
├── 섹션 1: 포트폴리오 요약 (1~3행)
├── (빈 행)
├── 섹션 2: 월별 성과 (5행~)
├── (빈 행)
├── 섹션 3: 종목별 현황 (N행~)
├── (빈 행)
└── 섹션 4: 투자 지표 (N행~)
```

#### 섹션 1: 포트폴리오 요약

한 눈에 보는 핵심 수치. 시트 최상단에 가로 배치.

| 지표 | 설명 | 산출 방식 |
|------|------|----------|
| 총 매수금액(원) | 전 계좌 누적 매수 총액 | 전체 매수 거래의 amount_krw 합 |
| 총 매도금액(원) | 전 계좌 누적 매도 총액 | 전체 매도 거래의 amount_krw 합 |
| 총 실현손익(원) | 전 계좌 실현손익 합계 | 전체 profit_krw 합 |
| 총 수익률(%) | 실현손익 / 매도금액 | 총 실현손익 / 총 매도금액 |
| 총 거래건수 | 전체 거래 수 | 매수 + 매도 건수 |
| 승률(%) | 수익 거래 비율 | 수익 매도건수 / 전체 매도건수 |

**레이아웃 예시:**

```
| 지표         | 총 매수금액(원) | 총 매도금액(원) | 총 실현손익(원) | 총 수익률(%) | 총 거래건수 | 승률(%) |
| 값           | 45,230,000     | 12,500,000     | 1,234,567      | 9.88%       | 156        | 62.5%  |
```

#### 섹션 2: 월별 성과

기존 `요약_월별` 데이터에 수익률 컬럼을 추가.

| 컬럼 | 설명 | 포맷 |
|------|------|------|
| 연월 | YYYY-MM | 텍스트 |
| 계좌 | 증권사_계좌유형 | 텍스트 |
| 매수건수 | 해당 월 매수 건수 | `#,##0` |
| 매수금액(원) | 해당 월 매수 총액 | `#,##0` |
| 매도건수 | 해당 월 매도 건수 | `#,##0` |
| 매도금액(원) | 해당 월 매도 총액 | `#,##0` |
| 실현손익(원) | 해당 월 실현손익 | `#,##0` |
| 수익률(%) | 실현손익 / 매도금액 | `0.00%` |

#### 섹션 3: 종목별 현황

기존 `요약_종목별` 데이터에 수익률, 투자 비중 컬럼을 추가.

| 컬럼 | 설명 | 포맷 |
|------|------|------|
| 종목명 | 종목명 | 텍스트 |
| 종목코드 | 티커/코드 | 텍스트 |
| 계좌 | 증권사_계좌유형 | 텍스트 |
| 통화 | KRW/USD/JPY | 텍스트 |
| 총매수수량 | 누적 매수 수량 | `#,##0` |
| 총매수금액(원) | 누적 매수 원화 금액 | `#,##0` |
| 총매도수량 | 누적 매도 수량 | `#,##0` |
| 총매도금액(원) | 누적 매도 원화 금액 | `#,##0` |
| 실현손익(원) | 누적 실현손익 | `#,##0` |
| 수익률(%) | 실현손익 / 매도금액 | `0.00%` |
| 투자비중(%) | 종목 매수금액 / 전체 매수금액 | `0.00%` |

#### 섹션 4: 투자 지표

트레이딩 품질을 진단하는 핵심 지표 모음.

| 지표 | 설명 | 산출 방식 |
|------|------|----------|
| 계좌별 투자비중 | 계좌별 매수금액 비율 | 계좌 매수금액 / 전체 매수금액 |
| 통화별 투자비중 | 통화별 매수금액 비율 | 통화별 매수금액(원) / 전체 매수금액 |
| 상위 5종목 집중도(%) | 매수금액 기준 상위 5종목의 비중 합 | 상위5 매수금액 합 / 전체 매수금액 |
| 평균 수익률(%) | 수익 거래의 평균 수익률 | 수익 거래 profit_rate 평균 |
| 평균 손실률(%) | 손실 거래의 평균 손실률 | 손실 거래 profit_rate 평균 |
| 손익비 | 평균 수익 / 평균 손실 | 평균 수익률 / |평균 손실률| |
| 최대 수익 종목 | 실현손익 최대 종목 | profit_krw 최대값 종목명 |
| 최대 손실 종목 | 실현손익 최소 종목 | profit_krw 최소값 종목명 |

**레이아웃 예시:**

```
[투자 지표]
| 지표                   | 값         |
|------------------------|-----------|
| 계좌별 투자비중         |           |
|   미래에셋증권_국내계좌  | 45.2%    |
|   미래에셋증권_해외계좌  | 35.8%    |
|   한국투자증권_국내계좌  | 19.0%    |
| 통화별 투자비중         |           |
|   KRW                  | 64.2%    |
|   USD                  | 30.5%    |
|   JPY                  | 5.3%     |
| 상위 5종목 집중도       | 42.3%    |
| 평균 수익률             | 8.52%    |
| 평균 손실률             | -3.21%   |
| 손익비                  | 2.65     |
| 최대 수익 종목          | TIGER 조선TOP10 (+234,500원) |
| 최대 손실 종목          | 삼성전자 (-45,000원)         |
```

## 3. 기술 변경 사항

### 3.1 google_sheets_client.py - 신규 메서드

| 메서드 | 용도 |
|--------|------|
| `freeze_rows(sheet_name, row_count)` | 지정 행 고정 |
| `set_auto_filter(sheet_name, range)` | 자동 필터 설정 |
| `apply_number_format_to_columns(sheet_name, column_formats)` | 컬럼별 숫자 포맷 일괄 적용 |

### 3.2 sheet_writer.py - 변경 사항

- `ensure_sheet_exists()`: 시트 생성 후 freeze + filter 적용 추가
- `insert_trades()`: 데이터 삽입 후 numberFormat 적용 추가
- Trade 데이터를 문자열이 아닌 숫자 값으로 삽입하도록 변경
- 수익률 값을 퍼센트 소수(예: `0.1468`)로 변환하여 삽입

### 3.3 summary_generator.py - 변경 사항

- `요약_월별`, `요약_종목별` 시트 생성 로직 → `대시보드` 단일 시트로 통합
- 섹션별 데이터 작성 로직 추가
- 투자 지표 산출 로직 추가
- 대시보드 시트에도 freeze + filter + numberFormat 적용

### 3.4 models.py - 변경 사항

- `to_domestic_row()`: 숫자 값을 문자열이 아닌 원시 타입(int/float)으로 반환
- `to_foreign_row()`: 동일
- `profit_rate` 값을 백분율 소수로 변환 (예: `14.68` → `0.1468`)

## 4. 작업 목록

### Phase 1: 매매일지 시트 포맷 개선

1. `google_sheets_client.py`에 `freeze_rows()`, `set_auto_filter()` 메서드 추가
2. `sheet_writer.py`의 `ensure_sheet_exists()`에서 시트 생성 시 freeze + filter 적용
3. `models.py`의 `to_domestic_row()`, `to_foreign_row()`에서 숫자 값을 원시 타입으로 반환
4. `sheet_writer.py`의 `insert_trades()`에서 데이터 삽입 후 컬럼별 numberFormat 적용
5. 기존 시트에도 매 실행 시 freeze + filter 적용되도록 처리

### Phase 2: 대시보드 시트 구현

6. `summary_generator.py`에서 기존 `요약_월별`, `요약_종목별` 생성 로직을 `대시보드` 시트로 통합
7. 포트폴리오 요약(섹션 1) 산출 및 작성 로직 구현
8. 월별 성과(섹션 2)에 수익률 컬럼 추가
9. 종목별 현황(섹션 3)에 수익률, 투자 비중 컬럼 추가
10. 투자 지표(섹션 4) 산출 및 작성 로직 구현
11. 대시보드 시트에 freeze + numberFormat 적용

### Phase 3: 정리 및 테스트

12. 기존 `요약_월별`, `요약_종목별` 시트 생성 코드 제거
13. 테스트 코드 업데이트 (새 포맷 반영)
14. dry-run 모드로 전체 파이프라인 검증
