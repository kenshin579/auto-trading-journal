# Auto Trading Journal v2 - PRD

## 1. 프로젝트 목표

기존 매매일지 시스템을 전면 재설계하여 다음을 달성한다:
- 증권사별 CSV 파일을 파싱하여 Google Sheets에 매매일지를 자동 작성
- 매수/매도를 하나의 시트에서 통합 관리
- 요약 시트를 통한 월별/종목별 투자 현황 파악
- 새로운 계좌/증권사 추가 시 시트 자동 생성

## 2. 현재 문제점 (v1)

| 문제 | 설명 |
|------|------|
| 시트 분리 과다 | 매수/매도, 주식/ETF를 별도 시트로 분리 → 시트 8개/계좌 |
| md 입력 포맷 | 사람이 직접 마크다운 테이블을 편집해야 함 |
| 증권사 포맷 미지원 | 증권사에서 다운로드한 CSV를 직접 사용할 수 없음 |
| 요약 기능 없음 | 월별/종목별 투자 현황을 한눈에 볼 수 없음 |
| 통화 미구분 | 해외 거래에서 USD/JPY 등 통화별 구분이 불명확 |

## 3. 입력 파일 규격

### 3.1 디렉토리 구조

```
stocks/
└── {증권사명}/
    ├── 국내계좌.csv
    └── 해외계좌.csv
```

- 파일명이 곧 시트명이 된다: `{증권사명}_국내계좌`, `{증권사명}_해외계좌`
- 새로운 증권사 폴더를 추가하면 자동으로 해당 시트가 생성된다

### 3.2 CSV 포맷 (증권사별)

#### 미래에셋증권 - 국내계좌

```
일자,종목명,기간 중 매수,,,기간 중 매도,,,매매비용,손익금액,수익률
,,수량,평균단가,매수금액,수량,평균단가,매도금액,,,
2026/02/13,TIGER 조선TOP10,2,28230,56460,0,0,0,0,0,0.00
```

- 매수/매도가 한 행에 공존 (매수금액 > 0이면 매수, 매도금액 > 0이면 매도, 둘 다 가능)
- 통화: KRW (고정)

#### 미래에셋증권 - 해외계좌

```
매매일,통화,종목번호,종목명,잔고 수량,매입평균환율,매매일환율,매수 수량,매수단가,매수금액,원화매수금액,매도 수량,매도단가,매도금액,원화매도금액,수수료,세금,원화총비용,원매수평균가,매매손익,원화매매손익,환차손익,총평가손익,손익률,환산손익률
```

- 통화: USD, JPY 등 다중 통화 지원
- 매수/매도가 한 행에 공존

#### 한국투자증권 - 국내계좌

```
"매매일자","종목명","종목코드","구분","대출일자","보유수량","매입단가","매수수량","매도단가","매도수량","매수금액","매도금액","실현손익","손익률","수수료","이자","제세금"
```

- 쌍따옴표로 감싸진 CSV
- 숫자에 천단위 쉼표 포함 (예: `"18,609"`)
- 빈 행이 포함될 수 있음 (종목명이 빈 행은 무시)

### 3.3 새로운 증권사 추가 방법

새 증권사의 CSV가 추가되면:
1. `stocks/{증권사명}/` 폴더에 CSV 파일을 넣는다
2. 파서(Parser)가 헤더를 분석하여 자동으로 포맷을 감지한다
3. 감지 불가 시 에러 로그를 남기고 해당 파일은 건너뛴다

## 4. Google Sheets 구조

하나의 Google Spreadsheet 안에 매매일지 시트와 요약 시트를 모두 탭으로 관리한다.

```
[Google Spreadsheet]
├── 미래에셋증권_국내계좌    ← 매매일지 시트 (자동 생성)
├── 미래에셋증권_해외계좌    ← 매매일지 시트 (자동 생성)
├── 한국투자증권_국내계좌    ← 매매일지 시트 (자동 생성)
├── 요약_월별              ← 요약 시트 (매 실행 시 재생성)
└── 요약_종목별            ← 요약 시트 (매 실행 시 재생성)
```

### 4.1 매매일지 시트

시트 하나에 매수와 매도를 모두 기록한다. 증권사/계좌별로 시트를 분리한다.

#### 시트명 규칙

```
{증권사명}_{계좌유형}
```

예시:
- `미래에셋증권_국내계좌`
- `미래에셋증권_해외계좌`
- `한국투자증권_국내계좌`

#### 국내계좌 시트 컬럼

| 컬럼 | 설명 | 예시 |
|------|------|------|
| 일자 | 매매일 (YYYY-MM-DD) | 2026-02-13 |
| 구분 | 매수/매도 | 매수 |
| 종목명 | 종목명 | TIGER 조선TOP10 |
| 수량 | 매매 수량 | 2 |
| 단가 | 매매 단가 | 28,230 |
| 금액 | 매매 금액 | 56,460 |
| 수수료 | 매매비용 | 0 |
| 손익금액 | 실현손익 | 0 |
| 수익률(%) | 실현수익률 | 0.00 |

- 하나의 CSV 행에서 매수와 매도가 동시에 발생하면 2행으로 분리하여 기록
- 매수수량 > 0이면 매수 행 생성, 매도수량 > 0이면 매도 행 생성

#### 해외계좌 시트 컬럼

| 컬럼 | 설명 | 예시 |
|------|------|------|
| 일자 | 매매일 (YYYY-MM-DD) | 2026-02-04 |
| 구분 | 매수/매도 | 매수 |
| 통화 | 거래 통화 | USD |
| 종목코드 | 티커 | AAPL |
| 종목명 | 종목명 | 아메리칸 엑스프레스 |
| 수량 | 매매 수량 | 2 |
| 단가 | 외화 단가 | 42.60 |
| 금액(외화) | 외화 금액 | 85.20 |
| 환율 | 매매일 환율 | 1,449.00 |
| 금액(원화) | 원화 환산 금액 | 123,454 |
| 수수료 | 거래수수료 | 0 |
| 세금 | 제세금 | 0 |
| 손익(외화) | 외화 매매손익 | 0 |
| 손익(원화) | 원화 총손익 | 0 |
| 수익률(%) | 손익률 | 0.00 |

### 4.2 요약 시트

동일 Spreadsheet 내 별도 탭으로 생성된다. 매매일지 시트 데이터를 읽어서 매 실행 시 초기화 후 재작성(덮어쓰기)한다.

#### 시트명: `요약_월별`

월별로 매수/매도 금액을 집계한다.

| 컬럼 | 설명 |
|------|------|
| 연월 | YYYY-MM |
| 계좌 | 증권사_계좌유형 |
| 매수건수 | 해당 월 매수 거래 건수 |
| 매수금액(원) | 해당 월 총 매수금액 (해외는 원화환산) |
| 매도건수 | 해당 월 매도 거래 건수 |
| 매도금액(원) | 해당 월 총 매도금액 (해외는 원화환산) |
| 실현손익(원) | 해당 월 실현손익 합계 |

#### 시트명: `요약_종목별`

종목별로 매수/매도 누적 현황을 보여준다.

| 컬럼 | 설명 |
|------|------|
| 종목명 | 종목명 |
| 종목코드 | 티커 (해외) 또는 종목코드 (국내) |
| 계좌 | 증권사_계좌유형 |
| 통화 | KRW / USD / JPY 등 |
| 총매수수량 | 누적 매수 수량 |
| 총매수금액(원) | 누적 매수금액 (원화환산) |
| 총매도수량 | 누적 매도 수량 |
| 총매도금액(원) | 누적 매도금액 (원화환산) |
| 실현손익(원) | 누적 실현손익 |

## 5. 핵심 기능

### 5.1 CSV 파싱 및 정규화

- 증권사별 CSV 포맷을 자동 감지 (헤더 기반)
- 각 증권사 포맷을 공통 내부 모델(Trade)로 변환
- 하나의 행에 매수+매도가 동시에 있으면 별도 Trade로 분리
- 수량이 0인 거래는 무시
- 빈 행/잘못된 행은 건너뜀

### 5.2 시트 자동 생성

- `stocks/` 하위의 폴더/파일 구조를 스캔
- 해당 시트가 없으면 자동으로 새 시트 생성
- 시트 생성 시 헤더행 자동 삽입

### 5.3 중복 방지

- (일자, 구분, 종목명, 수량, 단가) 조합으로 중복 체크
- 이미 존재하는 거래는 건너뜀

### 5.4 날짜별 색상 구분

- 기존 v1의 8색 팔레트 유지
- 같은 날짜의 거래는 동일한 배경색 적용

### 5.5 요약 시트 갱신

- 매매일지 시트 데이터를 읽어 요약 시트를 재생성
- 매번 실행 시 요약 시트를 초기화 후 재작성 (덮어쓰기 방식)

## 6. 통화 처리 방침

| 항목 | 처리 방법 |
|------|----------|
| 국내계좌 | 통화 필드 없음, 모든 금액은 KRW |
| 해외계좌 (USD) | 외화 금액과 원화 환산 금액 모두 기록 |
| 해외계좌 (JPY) | USD와 동일한 방식으로 처리 |
| 요약 시트 | 모든 금액을 원화(KRW)로 환산하여 집계 |

- 해외 CSV에는 매매일 환율과 원화 환산금액이 이미 포함되어 있으므로 별도 환율 조회는 불필요

## 7. 기술 설계 방향

### 7.1 모듈 구조 (재설계)

```
main.py                    # 진입점
config/config.yaml         # 설정
modules/
├── parsers/               # 증권사별 CSV 파서
│   ├── base_parser.py     # 파서 추상 클래스
│   ├── mirae_parser.py    # 미래에셋증권 파서
│   └── hankook_parser.py  # 한국투자증권 파서
├── models.py              # Trade 데이터 모델
├── parser_registry.py     # 헤더 기반 파서 자동 선택
├── sheets_client.py       # Google Sheets API 래퍼
├── sheet_writer.py        # 시트 쓰기 (생성/삽입/색상)
├── summary_generator.py   # 요약 시트 생성
└── duplicate_checker.py   # 중복 체크
```

### 7.2 데이터 모델

```python
@dataclass
class Trade:
    date: str              # YYYY-MM-DD
    trade_type: str        # 매수 / 매도
    stock_name: str        # 종목명
    stock_code: str        # 종목코드/티커 (없으면 빈 문자열)
    quantity: float        # 수량
    price: float           # 단가
    amount: float          # 금액
    currency: str          # KRW / USD / JPY
    exchange_rate: float   # 환율 (국내는 1.0)
    amount_krw: float      # 원화 환산 금액
    fee: float             # 수수료
    tax: float             # 세금
    profit: float          # 실현손익
    profit_krw: float      # 원화 실현손익
    profit_rate: float     # 수익률(%)
    account: str           # 증권사_계좌유형
```

### 7.3 기존 코드 활용 계획

| 기존 모듈 | 처리 |
|-----------|------|
| `google_sheets_client.py` | **유지** - API 래퍼는 그대로 사용 |
| `sheet_manager.py` | **대폭 수정** - 새 시트 구조에 맞게 재작성 |
| `file_parser.py` | **교체** - parsers/ 디렉토리로 분리 |
| `trade_models.py` | **교체** - 통합 Trade 모델로 교체 |
| `stock_classifier.py` | **제거** - 주식/ETF 구분 불필요 |
| `data_validator.py` | **축소** - 파서 내부 검증으로 통합 |
| `report_generator.py` | **제거** - 요약 시트로 대체 |

## 8. 실행 흐름

```
1. stocks/ 디렉토리 스캔
   └── 증권사별 폴더 & CSV 파일 목록 수집

2. CSV 파일별 처리
   ├── 헤더 분석 → 파서 자동 선택
   ├── CSV 파싱 → Trade 목록 생성
   └── 검증 (날짜, 수량, 금액)

3. Google Sheets 처리
   ├── 시트 존재 확인 → 없으면 자동 생성
   ├── 기존 데이터 로드 → 중복 체크
   ├── 신규 Trade만 필터링
   └── 배치 삽입 (날짜별 색상 적용)

4. 요약 시트 갱신
   ├── 모든 매매일지 시트 데이터 읽기
   ├── 월별 요약 집계 → 요약_월별 시트 작성
   └── 종목별 요약 집계 → 요약_종목별 시트 작성

5. 결과 출력
   └── 처리 건수, 스킵 건수, 에러 건수 요약
```

## 9. 작업 목록

### Phase 1: 핵심 파싱 및 시트 작성

1. **Trade 데이터 모델 정의** - `modules/models.py`
2. **파서 추상 클래스 작성** - `modules/parsers/base_parser.py`
3. **미래에셋 국내 파서** - `modules/parsers/mirae_parser.py`
4. **미래에셋 해외 파서** - `modules/parsers/mirae_parser.py`
5. **한국투자증권 국내 파서** - `modules/parsers/hankook_parser.py`
6. **파서 레지스트리** - `modules/parser_registry.py` (헤더 기반 자동 선택)
7. **시트 자동 생성 기능** - `modules/sheet_writer.py`
8. **중복 체크 기능** - `modules/duplicate_checker.py`
9. **매매일지 삽입 (색상 포함)** - `modules/sheet_writer.py`
10. **main.py 재작성** - 새 파이프라인 연결

### Phase 2: 요약 시트

11. **월별 요약 시트 생성** - `modules/summary_generator.py`
12. **종목별 요약 시트 생성** - `modules/summary_generator.py`

### Phase 3: 정리 및 테스트

13. **기존 불필요 코드 제거** (`stock_classifier.py`, `report_generator.py`, `data_validator.py` 등)
14. **테스트 작성** (파서 단위 테스트, 통합 테스트)
15. **CLAUDE.md 업데이트** (v2 구조 반영)
